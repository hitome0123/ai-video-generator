<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI çŸ­è§†é¢‘ç”Ÿæˆå™¨</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      min-height: 100vh;
    }

    header {
      background: #000;
      color: #fff;
      padding: 20px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 { font-size: 20px; font-weight: 600; }
    header span { font-size: 13px; color: #aaa; display: block; margin-top: 2px; }
    header a.history-link {
      font-size: 13px;
      color: #aaa;
      text-decoration: none;
      padding: 6px 12px;
      border: 1px solid #444;
      border-radius: 8px;
      flex-shrink: 0;
    }
    header a.history-link:hover { color: #fff; border-color: #888; }

    .container {
      max-width: 680px;
      margin: 40px auto;
      padding: 0 20px 60px;
    }

    /* â”€â”€ å¡ç‰‡ â”€â”€ */
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
    }
    .card-title {
      font-size: 15px;
      font-weight: 600;
      color: #555;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-title .num {
      width: 24px; height: 24px;
      background: #000; color: #fff;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 700;
      flex-shrink: 0;
    }

    /* â”€â”€ å›¾ç‰‡ä¸Šä¼ åŒº â”€â”€ */
    .upload-area {
      border: 2px dashed #ddd;
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      position: relative;
    }
    .upload-area:hover, .upload-area.drag-over {
      border-color: #000;
      background: #fafafa;
    }
    .upload-area input[type=file] {
      position: absolute; inset: 0; opacity: 0; cursor: pointer;
    }
    .upload-icon { font-size: 48px; margin-bottom: 12px; }
    .upload-text { font-size: 15px; color: #333; margin-bottom: 4px; }
    .upload-hint { font-size: 13px; color: #999; }

    .preview-wrap {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    .preview-wrap img {
      max-height: 240px;
      max-width: 100%;
      border-radius: 8px;
      object-fit: contain;
    }
    .preview-wrap .change-btn {
      font-size: 13px; color: #666;
      background: none; border: 1px solid #ddd;
      border-radius: 6px; padding: 4px 12px;
      cursor: pointer;
    }
    .preview-wrap .change-btn:hover { border-color: #999; }

    /* â”€â”€ è¡¨å• â”€â”€ */
    label {
      display: block;
      font-size: 13px;
      color: #666;
      margin-bottom: 6px;
    }
    input[type=text], textarea {
      width: 100%;
      padding: 12px 14px;
      border: 1.5px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      font-family: inherit;
      color: #1d1d1f;
      outline: none;
      transition: border-color 0.2s;
    }
    input[type=text]:focus, textarea:focus { border-color: #000; }
    textarea { resize: vertical; min-height: 110px; line-height: 1.6; }

    /* â”€â”€ AI å»ºè®®æŒ‰é’® â”€â”€ */
    .ai-btn {
      margin-top: 8px;
      padding: 8px 14px;
      background: none;
      border: 1.5px solid #ddd;
      border-radius: 8px;
      font-size: 13px;
      color: #555;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .ai-btn:hover { border-color: #000; color: #000; }
    .ai-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* â”€â”€ AI å»ºè®®æ ‡ç­¾ â”€â”€ */
    .suggestion-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .suggestion-tag {
      padding: 5px 12px;
      background: #f0f0f0;
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
      border: 1.5px solid transparent;
    }
    .suggestion-tag:hover { background: #e0e0e0; border-color: #bbb; }
    .hint-text { font-size: 12px; color: #aaa; margin-top: 6px; }

    /* â”€â”€ ç«å“åˆ†æ â”€â”€ */
    .collapsible-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 14px 0;
      border-top: 1px solid #f0f0f0;
      margin-top: 16px;
    }
    .collapsible-header span { font-size: 13px; color: #666; }
    .collapsible-header .arrow { font-size: 11px; color: #aaa; transition: transform 0.2s; }
    .collapsible-header.open .arrow { transform: rotate(180deg); }
    .collapsible-body { display: none; padding-top: 12px; }
    .collapsible-body.open { display: block; }

    .competitor-result {
      background: #f5f5f7;
      border-radius: 10px;
      padding: 14px;
      margin-top: 10px;
      font-size: 13px;
      line-height: 1.7;
      display: none;
    }
    .competitor-result.show { display: block; }
    .cr-section { margin-bottom: 10px; }
    .cr-section strong { color: #333; display: block; margin-bottom: 4px; }
    .cr-tag {
      display: inline-block;
      padding: 3px 10px;
      background: #e8f5e9;
      border-radius: 12px;
      margin: 2px 3px;
      cursor: pointer;
    }
    .cr-tag:hover { background: #c8e6c9; }

    /* â”€â”€ ç”ŸæˆæŒ‰é’® â”€â”€ */
    .generate-btn {
      width: 100%;
      padding: 16px;
      background: #000;
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
      margin-top: 8px;
    }
    .generate-btn:hover { opacity: 0.85; }
    .generate-btn:active { transform: scale(0.99); }
    .generate-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* â”€â”€ è¿›åº¦å¡ç‰‡ â”€â”€ */
    #progress-section { display: none; }

    .steps {
      display: flex;
      flex-direction: column;
      gap: 0;
      margin-bottom: 24px;
    }
    .step-item {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      padding: 14px 0;
      border-bottom: 1px solid #f0f0f0;
      position: relative;
    }
    .step-item:last-child { border-bottom: none; }

    .step-icon {
      width: 32px; height: 32px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .step-icon.pending   { background: #f0f0f0; color: #aaa; }
    .step-icon.active    { background: #000; color: #fff; animation: pulse 1.2s infinite; }
    .step-icon.done      { background: #34c759; color: #fff; }
    .step-icon.failed    { background: #ff3b30; color: #fff; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .step-content { flex: 1; }
    .step-label { font-size: 15px; font-weight: 500; color: #1d1d1f; }
    .step-desc  { font-size: 13px; color: #999; margin-top: 2px; }
    .step-desc.active { color: #555; }

    /* â”€â”€ ç»“æœåŒº â”€â”€ */
    #result-section { display: none; }

    .result-info {
      background: #f5f5f7;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .result-info p { font-size: 13px; color: #666; line-height: 1.7; }
    .result-info strong { color: #333; }

    .download-btn {
      width: 100%;
      padding: 16px;
      background: #34c759;
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .download-btn:hover { opacity: 0.85; }

    .restart-btn {
      width: 100%;
      padding: 12px;
      background: none;
      color: #555;
      border: 1.5px solid #ddd;
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
      transition: border-color 0.2s;
    }
    .restart-btn:hover { border-color: #999; }

    /* â”€â”€ é”™è¯¯ â”€â”€ */
    .error-box {
      background: #fff2f2;
      border: 1px solid #ffcccc;
      border-radius: 10px;
      padding: 14px;
      color: #c00;
      font-size: 14px;
      line-height: 1.5;
      display: none;
    }

    /* â”€â”€ æœåŠ¡é€‰æ‹©å™¨ â”€â”€ */
    .service-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .service-option {
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 14px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      position: relative;
    }
    .service-option input[type=radio] {
      position: absolute;
      opacity: 0;
      width: 0; height: 0;
    }
    .service-option.selected {
      border-color: #000;
      background: #fafafa;
    }
    .service-option:hover { border-color: #aaa; }
    .service-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .service-badge {
      font-size: 10px;
      background: #000;
      color: #fff;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }
    .service-desc {
      font-size: 12px;
      color: #888;
      line-height: 1.5;
    }
    .service-cost {
      font-size: 12px;
      color: #34c759;
      font-weight: 500;
      margin-top: 4px;
    }

    /* â”€â”€ åå¤„ç†å¼€å…³ â”€â”€ */
    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #f5f5f5;
    }
    .toggle-row:last-child { border-bottom: none; padding-bottom: 0; }
    .toggle-label { font-size: 14px; color: #333; }
    .toggle-hint  { font-size: 12px; color: #aaa; margin-top: 2px; }

    .toggle {
      position: relative;
      width: 44px; height: 26px;
      flex-shrink: 0;
    }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute;
      inset: 0;
      background: #ccc;
      border-radius: 26px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .slider:before {
      content: "";
      position: absolute;
      width: 20px; height: 20px;
      left: 3px; bottom: 3px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.2s;
    }
    .toggle input:checked + .slider { background: #000; }
    .toggle input:checked + .slider:before { transform: translateX(18px); }

    /* â”€â”€ æˆæœ¬æç¤º â”€â”€ */
    .cost-tip {
      text-align: center;
      font-size: 12px;
      color: #bbb;
      margin-top: 8px;
    }
  </style>
</head>
<body>

<header>
  <div>
    <h1>AI çŸ­è§†é¢‘ç”Ÿæˆå™¨</h1>
    <span>è¾“å…¥äº§å“ç…§ç‰‡ï¼Œè‡ªåŠ¨ç”Ÿæˆ TikTok å¸¦è´§è§†é¢‘</span>
  </div>
  <a class="history-link" href="/history.html">å†å²è®°å½•</a>
</header>

<div class="container">

  <!-- â”€â”€ ä¸Šä¼ è¡¨å• â”€â”€ -->
  <div id="form-section">

    <!-- 1. ä¸Šä¼ å›¾ç‰‡ -->
    <div class="card">
      <div class="card-title">
        <span class="num">1</span> ä¸Šä¼ äº§å“å›¾ç‰‡
      </div>

      <div class="upload-area" id="upload-area">
        <input type="file" id="image-input" accept="image/*">
        <div id="upload-placeholder">
          <div class="upload-icon">ğŸ“·</div>
          <div class="upload-text">ç‚¹å‡»ä¸Šä¼  / æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
          <div class="upload-hint">æ”¯æŒ JPGã€PNGï¼Œå»ºè®®ä½¿ç”¨ç™½åº•æˆ–æ¸…æ™°èƒŒæ™¯</div>
        </div>
        <div class="preview-wrap" id="preview-wrap">
          <img id="image-preview" src="" alt="é¢„è§ˆ">
          <button class="change-btn" onclick="resetImage(event)">é‡æ–°é€‰æ‹©å›¾ç‰‡</button>
        </div>
      </div>
    </div>

    <!-- 2. äº§å“ä¿¡æ¯ -->
    <div class="card">
      <div class="card-title">
        <span class="num">2</span> å¡«å†™äº§å“ä¿¡æ¯
      </div>

      <label>äº§å“åç§°</label>
      <input type="text" id="product-name" placeholder="ä¾‹å¦‚ï¼šæ™ºèƒ½æ‰‹è¡¨ V8 Pro">

      <div style="height:16px"></div>

      <label>
        æ ¸å¿ƒå–ç‚¹
        <span style="font-weight:400;color:#bbb">ï¼ˆæ¯è¡Œå†™ä¸€ä¸ªï¼Œè‡³å°‘å¡«å†™ 1 ä¸ªï¼‰</span>
      </label>
      <textarea id="selling-points"
        placeholder="30å¤©è¶…é•¿ç»­èˆª&#10;50ç±³é˜²æ°´&#10;24å°æ—¶å¿ƒç‡ç›‘æµ‹&#10;100+ è¿åŠ¨æ¨¡å¼"></textarea>

      <button class="ai-btn" id="suggest-btn" onclick="suggestSellingPoints()">
        <span>âœ¨</span> AI è¡¥å……å–ç‚¹å»ºè®®
      </button>

      <div class="suggestion-tags" id="suggestion-tags"></div>
      <div class="hint-text" id="suggestion-hint" style="display:none">
        ç‚¹å‡»æ ‡ç­¾å¯å°†å…¶è¿½åŠ åˆ°å–ç‚¹åˆ—è¡¨
      </div>

      <!-- ç«å“æ–‡æ¡ˆåˆ†æï¼ˆæŠ˜å ï¼‰ -->
      <div class="collapsible-header" id="comp-header" onclick="toggleCompetitor()">
        <span>ğŸ“Š åˆ†æç«å“æ–‡æ¡ˆï¼Œæå–å¯å€Ÿé‰´å–ç‚¹</span>
        <span class="arrow" id="comp-arrow">â–¼</span>
      </div>
      <div class="collapsible-body" id="comp-body">
        <label>ç²˜è´´ç«å“è§†é¢‘æ ‡é¢˜ / æè¿°</label>
        <textarea id="competitor-text" style="min-height:80px"
          placeholder="ç²˜è´´ TikTok ç«å“è§†é¢‘çš„æ ‡é¢˜ã€æ–‡æ¡ˆæˆ–è¯„è®º..."></textarea>
        <button class="ai-btn" id="analyze-btn" onclick="analyzeCompetitor()" style="margin-top:8px">
          <span>ğŸ”</span> åˆ†æ
        </button>

        <div class="competitor-result" id="comp-result">
          <div class="cr-section">
            <strong>æ ¸å¿ƒå–ç‚¹</strong>
            <div id="comp-points"></div>
          </div>
          <div class="cr-section">
            <strong>å¼€å¤´é’©å­</strong>
            <div id="comp-hooks"></div>
          </div>
          <div class="cr-section" id="comp-summary-wrap">
            <strong>ç­–ç•¥æ‘˜è¦</strong>
            <div id="comp-summary"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 3. é€‰æ‹©è§†é¢‘æœåŠ¡ -->
    <div class="card">
      <div class="card-title">
        <span class="num">3</span> é€‰æ‹©è§†é¢‘ç”ŸæˆæœåŠ¡
      </div>
      <div class="service-options">
        <label class="service-option selected" id="opt-seedance" onclick="selectService('seedance')">
          <input type="radio" name="video_service" value="seedance" checked>
          <div class="service-name">
            è±†åŒ… Seedance
            <span class="service-badge">æ¨è</span>
          </div>
          <div class="service-desc">å­—èŠ‚è·³åŠ¨å®˜æ–¹æ¨¡å‹<br>å›½å†…ç›´è¿ Â· å›¾ç”Ÿè§†é¢‘</div>
          <div class="service-cost">çº¦ Â¥0.9 / æ¬¡</div>
        </label>
        <label class="service-option" id="opt-creatok" onclick="selectService('creatok')">
          <input type="radio" name="video_service" value="creatok">
          <div class="service-name">Creatok</div>
          <div class="service-desc">å›½é™…æœåŠ¡<br>15 ç§’è§†é¢‘</div>
          <div class="service-cost">çº¦ Â¥2.2 / æ¬¡</div>
        </label>
      </div>
    </div>

    <!-- 4. åå¤„ç†é€‰é¡¹ -->
    <div class="card">
      <div class="card-title">
        <span class="num">4</span> åå¤„ç†é€‰é¡¹
      </div>

      <div class="toggle-row">
        <div>
          <div class="toggle-label">è‡ªåŠ¨æ·»åŠ å­—å¹•</div>
          <div class="toggle-hint">ä»è„šæœ¬æå–æ–‡æ¡ˆï¼Œç”¨ FFmpeg çƒ§å½•åˆ°è§†é¢‘ï¼ˆéœ€å®‰è£… FFmpegï¼‰</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="toggle-subtitle">
          <span class="slider"></span>
        </label>
      </div>

      <div class="toggle-row">
        <div>
          <div class="toggle-label">æ··å…¥èƒŒæ™¯éŸ³ä¹ï¼ˆBGMï¼‰</div>
          <div class="toggle-hint">ä» static/bgm/ ç›®å½•è¯»å–éŸ³é¢‘ï¼ˆéœ€é¢„å…ˆæ”¾ç½® mp3 æ–‡ä»¶ï¼‰</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="toggle-bgm">
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <!-- ç”ŸæˆæŒ‰é’® -->
    <button class="generate-btn" id="generate-btn" onclick="startGeneration()">
      å¼€å§‹ç”Ÿæˆè§†é¢‘
    </button>
    <div class="cost-tip" id="cost-tip">æ¯æ¬¡ç”Ÿæˆçº¦èŠ±è´¹ Â¥0.9ï¼ˆè±†åŒ… Seedanceï¼‰</div>

  </div>

  <!-- â”€â”€ è¿›åº¦å±•ç¤º â”€â”€ -->
  <div id="progress-section">
    <div class="card">
      <div class="card-title" style="margin-bottom:4px">
        â³ æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·å‹¿å…³é—­é¡µé¢...
      </div>
      <p style="font-size:13px;color:#999;margin-bottom:20px">
        æ•´ä¸ªæµç¨‹çº¦éœ€ 3-5 åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…
      </p>

      <div class="steps">
        <div class="step-item" id="step-1">
          <div class="step-icon pending" id="icon-1">1</div>
          <div class="step-content">
            <div class="step-label">åˆ†æäº§å“å›¾ç‰‡</div>
            <div class="step-desc" id="desc-1">GPT-4o è¯†åˆ«äº§å“å¤–è§‚ï¼Œç”Ÿæˆç™½åº•å›¾</div>
          </div>
        </div>
        <div class="step-item" id="step-2">
          <div class="step-icon pending" id="icon-2">2</div>
          <div class="step-content">
            <div class="step-label">ç”Ÿæˆè§†é¢‘è„šæœ¬</div>
            <div class="step-desc" id="desc-2">GPT-4o ç”Ÿæˆ TikTok è„šæœ¬å’Œè§†é¢‘æè¿°è¯</div>
          </div>
        </div>
        <div class="step-item" id="step-3">
          <div class="step-icon pending" id="icon-3">3</div>
          <div class="step-content">
            <div class="step-label">AI ç”Ÿæˆè§†é¢‘</div>
            <div class="step-desc" id="desc-3">AI æ¸²æŸ“ 9:16 çŸ­è§†é¢‘</div>
          </div>
        </div>
        <div class="step-item" id="step-4">
          <div class="step-icon pending" id="icon-4">4</div>
          <div class="step-content">
            <div class="step-label">åå¤„ç†</div>
            <div class="step-desc" id="desc-4">æ·»åŠ å­—å¹• / BGM</div>
          </div>
        </div>
      </div>

      <div class="error-box" id="error-box"></div>
    </div>
  </div>

  <!-- â”€â”€ å®Œæˆ / ä¸‹è½½ â”€â”€ -->
  <div id="result-section">
    <div class="card">
      <div class="card-title" style="color:#34c759">
        âœ… è§†é¢‘ç”Ÿæˆå®Œæˆï¼
      </div>

      <div class="result-info">
        <p>
          <strong>äº§å“ï¼š</strong><span id="result-product"></span><br>
          è§†é¢‘è§„æ ¼ï¼šMP4 / 9:16 ç«–ç‰ˆ<br>
          å¯ç›´æ¥å‘å¸ƒåˆ° TikTokã€æŠ–éŸ³ã€Instagram Reels
        </p>
      </div>

      <button class="download-btn" id="download-btn" onclick="downloadVideo()">
        â¬‡ï¸ ä¸‹è½½è§†é¢‘
      </button>

      <button class="restart-btn" onclick="restartForm()">
        é‡æ–°ç”Ÿæˆå¦ä¸€ä¸ªè§†é¢‘
      </button>
    </div>
  </div>

</div><!-- /container -->

<script>
  let currentJobId = null;
  let pollTimer = null;
  let selectedService = 'seedance';
  const TOTAL_STEPS = 4;

  // â”€â”€ è§†é¢‘æœåŠ¡é€‰æ‹© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function selectService(service) {
    selectedService = service;
    document.getElementById('opt-seedance').classList.toggle('selected', service === 'seedance');
    document.getElementById('opt-creatok').classList.toggle('selected', service === 'creatok');
    const costTip = document.getElementById('cost-tip');
    costTip.textContent = service === 'seedance'
      ? 'æ¯æ¬¡ç”Ÿæˆçº¦èŠ±è´¹ Â¥0.9ï¼ˆè±†åŒ… Seedanceï¼‰'
      : 'æ¯æ¬¡ç”Ÿæˆçº¦èŠ±è´¹ Â¥2.2ï¼ˆCreatokï¼‰';
  }

  // â”€â”€ å›¾ç‰‡ä¸Šä¼ å¤„ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const uploadArea = document.getElementById('upload-area');
  const imageInput = document.getElementById('image-input');

  uploadArea.addEventListener('dragover', e => {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
  });
  uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));
  uploadArea.addEventListener('drop', e => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) showPreview(file);
  });
  imageInput.addEventListener('change', () => {
    if (imageInput.files[0]) showPreview(imageInput.files[0]);
  });

  function showPreview(file) {
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById('image-preview').src = e.target.result;
      document.getElementById('upload-placeholder').style.display = 'none';
      document.getElementById('preview-wrap').style.display = 'flex';
    };
    reader.readAsDataURL(file);
  }

  function resetImage(e) {
    e.stopPropagation();
    imageInput.value = '';
    document.getElementById('image-preview').src = '';
    document.getElementById('upload-placeholder').style.display = 'block';
    document.getElementById('preview-wrap').style.display = 'none';
  }

  // â”€â”€ AI å–ç‚¹å»ºè®® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function suggestSellingPoints() {
    const productName = document.getElementById('product-name').value.trim();
    if (!productName) { alert('è¯·å…ˆå¡«å†™äº§å“åç§°'); return; }

    const existingText = document.getElementById('selling-points').value.trim();
    const existingPoints = existingText
      ? existingText.split('\n').map(l => l.trim()).filter(Boolean)
      : [];

    const btn = document.getElementById('suggest-btn');
    btn.disabled = true;
    btn.innerHTML = '<span>â³</span> ç”Ÿæˆä¸­...';

    try {
      const res = await fetch('/api/suggest-selling-points', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ product_name: productName, existing_points: existingPoints })
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || 'è¯·æ±‚å¤±è´¥');
      }

      const data = await res.json();
      renderSuggestions(data.suggestions);

    } catch (err) {
      alert('AI å»ºè®®å¤±è´¥ï¼š' + err.message);
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<span>âœ¨</span> AI è¡¥å……å–ç‚¹å»ºè®®';
    }
  }

  function renderSuggestions(suggestions) {
    const container = document.getElementById('suggestion-tags');
    const hint = document.getElementById('suggestion-hint');

    container.innerHTML = '';
    if (!suggestions || !suggestions.length) {
      hint.style.display = 'none';
      return;
    }

    suggestions.forEach(s => {
      const tag = document.createElement('span');
      tag.className = 'suggestion-tag';
      tag.textContent = s;
      tag.onclick = () => appendSuggestion(s, tag);
      container.appendChild(tag);
    });
    hint.style.display = 'block';
  }

  function appendSuggestion(text, tagEl) {
    const ta = document.getElementById('selling-points');
    const current = ta.value.trim();
    ta.value = current ? current + '\n' + text : text;
    tagEl.style.opacity = '0.4';
    tagEl.style.pointerEvents = 'none';
  }

  // â”€â”€ ç«å“æ–‡æ¡ˆåˆ†æ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleCompetitor() {
    const body = document.getElementById('comp-body');
    const header = document.getElementById('comp-header');
    body.classList.toggle('open');
    header.classList.toggle('open');
  }

  async function analyzeCompetitor() {
    const text = document.getElementById('competitor-text').value.trim();
    if (!text) { alert('è¯·ç²˜è´´ç«å“æ–‡æ¡ˆ'); return; }

    const btn = document.getElementById('analyze-btn');
    btn.disabled = true;
    btn.innerHTML = '<span>â³</span> åˆ†æä¸­...';

    try {
      const res = await fetch('/api/analyze-competitor', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || 'åˆ†æå¤±è´¥');
      }

      const data = await res.json();
      renderCompetitorResult(data);

    } catch (err) {
      alert('åˆ†æå¤±è´¥ï¼š' + err.message);
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<span>ğŸ”</span> åˆ†æ';
    }
  }

  function renderCompetitorResult(data) {
    const result = document.getElementById('comp-result');
    result.classList.add('show');

    const pointsEl = document.getElementById('comp-points');
    pointsEl.innerHTML = (data.selling_points || []).map(p =>
      `<span class="cr-tag" onclick="appendSuggestion('${p.replace(/'/g,"\\'")}', this)">${p}</span>`
    ).join('');

    const hooksEl = document.getElementById('comp-hooks');
    hooksEl.innerHTML = (data.hook_ideas || []).map(h =>
      `<span class="cr-tag">${h}</span>`
    ).join('');

    document.getElementById('comp-summary').textContent = data.summary || '';
  }

  // â”€â”€ å¼€å§‹ç”Ÿæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function startGeneration() {
    const imageFile = imageInput.files[0];
    const productName = document.getElementById('product-name').value.trim();
    const sellingPoints = document.getElementById('selling-points').value.trim();

    if (!imageFile) { alert('è¯·å…ˆä¸Šä¼ äº§å“å›¾ç‰‡'); return; }
    if (!productName) { alert('è¯·å¡«å†™äº§å“åç§°'); return; }
    if (!sellingPoints) { alert('è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªå–ç‚¹'); return; }

    const addSubtitle = document.getElementById('toggle-subtitle').checked;
    const addBgm = document.getElementById('toggle-bgm').checked;

    const formData = new FormData();
    formData.append('image', imageFile);
    formData.append('product_name', productName);
    formData.append('selling_points', sellingPoints);
    formData.append('video_service', selectedService);
    formData.append('add_subtitle', addSubtitle ? 'true' : 'false');
    formData.append('add_bgm', addBgm ? 'true' : 'false');

    const btn = document.getElementById('generate-btn');
    btn.disabled = true;
    btn.textContent = 'æäº¤ä¸­...';

    try {
      const res = await fetch('/api/generate', { method: 'POST', body: formData });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || 'æäº¤å¤±è´¥');
      }
      const data = await res.json();
      currentJobId = data.job_id;

      document.getElementById('form-section').style.display = 'none';
      document.getElementById('progress-section').style.display = 'block';

      pollTimer = setInterval(pollStatus, 4000);
      pollStatus();

    } catch (err) {
      btn.disabled = false;
      btn.textContent = 'å¼€å§‹ç”Ÿæˆè§†é¢‘';
      alert('é”™è¯¯ï¼š' + err.message);
    }
  }

  // â”€â”€ è½®è¯¢çŠ¶æ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function pollStatus() {
    if (!currentJobId) return;
    try {
      const res = await fetch(`/api/status/${currentJobId}`);
      if (!res.ok) return;
      const data = await res.json();

      updateSteps(data.step, data.status);

      if (data.status === 'success') {
        clearInterval(pollTimer);
        showResult(data.product_name);
      } else if (data.status === 'failed') {
        clearInterval(pollTimer);
        showError(data.error || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    } catch (e) { /* ç½‘ç»œé”™è¯¯ï¼Œç­‰ä¸‹æ¬¡è½®è¯¢ */ }
  }

  function updateSteps(currentStep, status) {
    for (let i = 1; i <= TOTAL_STEPS; i++) {
      const icon = document.getElementById(`icon-${i}`);
      const desc = document.getElementById(`desc-${i}`);

      icon.className = 'step-icon';
      desc.className = 'step-desc';

      if (status === 'failed' && i === currentStep) {
        icon.className += ' failed';
        icon.textContent = 'âœ•';
      } else if (i < currentStep || (status === 'success' && i <= TOTAL_STEPS)) {
        icon.className += ' done';
        icon.textContent = 'âœ“';
      } else if (i === currentStep) {
        icon.className += ' active';
        icon.textContent = i;
        desc.className += ' active';
      } else {
        icon.textContent = i;
      }
    }
  }

  // â”€â”€ å®Œæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showResult(productName) {
    updateSteps(TOTAL_STEPS, 'success');
    document.getElementById('progress-section').style.display = 'none';
    document.getElementById('result-section').style.display = 'block';
    document.getElementById('result-product').textContent = productName || '';
  }

  function showError(message) {
    const box = document.getElementById('error-box');
    box.style.display = 'block';
    box.textContent = 'âŒ ' + message;
  }

  function downloadVideo() {
    if (!currentJobId) return;
    window.location.href = `/api/download/${currentJobId}`;
  }

  function restartForm() {
    clearInterval(pollTimer);
    currentJobId = null;

    document.getElementById('product-name').value = '';
    document.getElementById('selling-points').value = '';
    document.getElementById('suggestion-tags').innerHTML = '';
    document.getElementById('suggestion-hint').style.display = 'none';
    document.getElementById('competitor-text').value = '';
    document.getElementById('comp-result').classList.remove('show');
    resetImage({ stopPropagation: () => {} });

    const btn = document.getElementById('generate-btn');
    btn.disabled = false;
    btn.textContent = 'å¼€å§‹ç”Ÿæˆè§†é¢‘';

    document.getElementById('result-section').style.display = 'none';
    document.getElementById('progress-section').style.display = 'none';
    document.getElementById('error-box').style.display = 'none';
    document.getElementById('form-section').style.display = 'block';

    for (let i = 1; i <= TOTAL_STEPS; i++) {
      const icon = document.getElementById(`icon-${i}`);
      icon.className = 'step-icon pending';
      icon.textContent = i;
      document.getElementById(`desc-${i}`).className = 'step-desc';
    }
  }
</script>

</body>
</html>
