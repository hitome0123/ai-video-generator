<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI çŸ­è§†é¢‘ç”Ÿæˆå™¨</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      min-height: 100vh;
    }

    header {
      background: #000;
      color: #fff;
      padding: 20px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    header h1 { font-size: 20px; font-weight: 600; }
    header span { font-size: 13px; color: #aaa; }

    .container {
      max-width: 680px;
      margin: 40px auto;
      padding: 0 20px 60px;
    }

    /* â”€â”€ å¡ç‰‡ â”€â”€ */
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 28px;
      margin-bottom: 20px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.07);
    }
    .card-title {
      font-size: 15px;
      font-weight: 600;
      color: #555;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-title .num {
      width: 24px; height: 24px;
      background: #000; color: #fff;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 700;
      flex-shrink: 0;
    }

    /* â”€â”€ å›¾ç‰‡ä¸Šä¼ åŒº â”€â”€ */
    .upload-area {
      border: 2px dashed #ddd;
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      position: relative;
    }
    .upload-area:hover, .upload-area.drag-over {
      border-color: #000;
      background: #fafafa;
    }
    .upload-area input[type=file] {
      position: absolute; inset: 0; opacity: 0; cursor: pointer;
    }
    .upload-icon { font-size: 48px; margin-bottom: 12px; }
    .upload-text { font-size: 15px; color: #333; margin-bottom: 4px; }
    .upload-hint { font-size: 13px; color: #999; }

    .preview-wrap {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    .preview-wrap img {
      max-height: 240px;
      max-width: 100%;
      border-radius: 8px;
      object-fit: contain;
    }
    .preview-wrap .change-btn {
      font-size: 13px; color: #666;
      background: none; border: 1px solid #ddd;
      border-radius: 6px; padding: 4px 12px;
      cursor: pointer;
    }
    .preview-wrap .change-btn:hover { border-color: #999; }

    /* â”€â”€ è¡¨å• â”€â”€ */
    label {
      display: block;
      font-size: 13px;
      color: #666;
      margin-bottom: 6px;
    }
    input[type=text], textarea {
      width: 100%;
      padding: 12px 14px;
      border: 1.5px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      font-family: inherit;
      color: #1d1d1f;
      outline: none;
      transition: border-color 0.2s;
    }
    input[type=text]:focus, textarea:focus { border-color: #000; }
    textarea { resize: vertical; min-height: 110px; line-height: 1.6; }

    /* â”€â”€ ç”ŸæˆæŒ‰é’® â”€â”€ */
    .generate-btn {
      width: 100%;
      padding: 16px;
      background: #000;
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
      margin-top: 8px;
    }
    .generate-btn:hover { opacity: 0.85; }
    .generate-btn:active { transform: scale(0.99); }
    .generate-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* â”€â”€ è¿›åº¦å¡ç‰‡ â”€â”€ */
    #progress-section { display: none; }

    .steps {
      display: flex;
      flex-direction: column;
      gap: 0;
      margin-bottom: 24px;
    }
    .step-item {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      padding: 14px 0;
      border-bottom: 1px solid #f0f0f0;
      position: relative;
    }
    .step-item:last-child { border-bottom: none; }

    .step-icon {
      width: 32px; height: 32px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .step-icon.pending   { background: #f0f0f0; color: #aaa; }
    .step-icon.active    { background: #000; color: #fff; animation: pulse 1.2s infinite; }
    .step-icon.done      { background: #34c759; color: #fff; }
    .step-icon.failed    { background: #ff3b30; color: #fff; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .step-content { flex: 1; }
    .step-label { font-size: 15px; font-weight: 500; color: #1d1d1f; }
    .step-desc  { font-size: 13px; color: #999; margin-top: 2px; }
    .step-desc.active { color: #555; }

    /* â”€â”€ ç»“æœåŒº â”€â”€ */
    #result-section { display: none; }

    .result-info {
      background: #f5f5f7;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .result-info p { font-size: 13px; color: #666; line-height: 1.7; }
    .result-info strong { color: #333; }

    .download-btn {
      width: 100%;
      padding: 16px;
      background: #34c759;
      color: #fff;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .download-btn:hover { opacity: 0.85; }

    .restart-btn {
      width: 100%;
      padding: 12px;
      background: none;
      color: #555;
      border: 1.5px solid #ddd;
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 10px;
      transition: border-color 0.2s;
    }
    .restart-btn:hover { border-color: #999; }

    /* â”€â”€ é”™è¯¯ â”€â”€ */
    .error-box {
      background: #fff2f2;
      border: 1px solid #ffcccc;
      border-radius: 10px;
      padding: 14px;
      color: #c00;
      font-size: 14px;
      line-height: 1.5;
      display: none;
    }

    /* â”€â”€ æœåŠ¡é€‰æ‹©å™¨ â”€â”€ */
    .service-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .service-option {
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 14px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      position: relative;
    }
    .service-option input[type=radio] {
      position: absolute;
      opacity: 0;
      width: 0; height: 0;
    }
    .service-option.selected {
      border-color: #000;
      background: #fafafa;
    }
    .service-option:hover { border-color: #aaa; }
    .service-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .service-badge {
      font-size: 10px;
      background: #000;
      color: #fff;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 500;
    }
    .service-desc {
      font-size: 12px;
      color: #888;
      line-height: 1.5;
    }
    .service-cost {
      font-size: 12px;
      color: #34c759;
      font-weight: 500;
      margin-top: 4px;
    }

    /* â”€â”€ æˆæœ¬æç¤º â”€â”€ */
    .cost-tip {
      text-align: center;
      font-size: 12px;
      color: #bbb;
      margin-top: 8px;
    }
  </style>
</head>
<body>

<header>
  <div>
    <h1>ğŸ¬ AI çŸ­è§†é¢‘ç”Ÿæˆå™¨</h1>
    <span>è¾“å…¥äº§å“ç…§ç‰‡ï¼Œè‡ªåŠ¨ç”Ÿæˆ TikTok å¸¦è´§è§†é¢‘</span>
  </div>
</header>

<div class="container">

  <!-- â”€â”€ ä¸Šä¼ è¡¨å• â”€â”€ -->
  <div id="form-section">

    <!-- 1. ä¸Šä¼ å›¾ç‰‡ -->
    <div class="card">
      <div class="card-title">
        <span class="num">1</span> ä¸Šä¼ äº§å“å›¾ç‰‡
      </div>

      <div class="upload-area" id="upload-area">
        <input type="file" id="image-input" accept="image/*">
        <div id="upload-placeholder">
          <div class="upload-icon">ğŸ“·</div>
          <div class="upload-text">ç‚¹å‡»ä¸Šä¼  / æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
          <div class="upload-hint">æ”¯æŒ JPGã€PNGï¼Œå»ºè®®ä½¿ç”¨ç™½åº•æˆ–æ¸…æ™°èƒŒæ™¯</div>
        </div>
        <div class="preview-wrap" id="preview-wrap">
          <img id="image-preview" src="" alt="é¢„è§ˆ">
          <button class="change-btn" onclick="resetImage(event)">é‡æ–°é€‰æ‹©å›¾ç‰‡</button>
        </div>
      </div>
    </div>

    <!-- 2. äº§å“ä¿¡æ¯ -->
    <div class="card">
      <div class="card-title">
        <span class="num">2</span> å¡«å†™äº§å“ä¿¡æ¯
      </div>

      <label>äº§å“åç§°</label>
      <input type="text" id="product-name"
        placeholder="ä¾‹å¦‚ï¼šæ™ºèƒ½æ‰‹è¡¨ V8 Pro">

      <div style="height:16px"></div>

      <label>æ ¸å¿ƒå–ç‚¹ <span style="font-weight:400;color:#bbb">ï¼ˆæ¯è¡Œå†™ä¸€ä¸ªï¼Œè‡³å°‘å¡«å†™ 1 ä¸ªï¼‰</span></label>
      <textarea id="selling-points"
        placeholder="30å¤©è¶…é•¿ç»­èˆª&#10;50ç±³é˜²æ°´&#10;24å°æ—¶å¿ƒç‡ç›‘æµ‹&#10;100+ è¿åŠ¨æ¨¡å¼"></textarea>
    </div>

    <!-- 3. é€‰æ‹©è§†é¢‘æœåŠ¡ -->
    <div class="card">
      <div class="card-title">
        <span class="num">3</span> é€‰æ‹©è§†é¢‘ç”ŸæˆæœåŠ¡
      </div>
      <div class="service-options">
        <!-- Seedance -->
        <label class="service-option selected" id="opt-seedance" onclick="selectService('seedance')">
          <input type="radio" name="video_service" value="seedance" checked>
          <div class="service-name">
            è±†åŒ… Seedance
            <span class="service-badge">æ¨è</span>
          </div>
          <div class="service-desc">å­—èŠ‚è·³åŠ¨å®˜æ–¹æ¨¡å‹<br>å›½å†…ç›´è¿ Â· å›¾ç”Ÿè§†é¢‘</div>
          <div class="service-cost">çº¦ Â¥0.9 / æ¬¡</div>
        </label>
        <!-- Creatok -->
        <label class="service-option" id="opt-creatok" onclick="selectService('creatok')">
          <input type="radio" name="video_service" value="creatok">
          <div class="service-name">Creatok</div>
          <div class="service-desc">å›½é™…æœåŠ¡<br>15 ç§’è§†é¢‘</div>
          <div class="service-cost">çº¦ Â¥2.2 / æ¬¡</div>
        </label>
      </div>
    </div>

    <!-- ç”ŸæˆæŒ‰é’® -->
    <button class="generate-btn" id="generate-btn" onclick="startGeneration()">
      å¼€å§‹ç”Ÿæˆè§†é¢‘
    </button>
    <div class="cost-tip" id="cost-tip">æ¯æ¬¡ç”Ÿæˆçº¦èŠ±è´¹ Â¥0.9ï¼ˆè±†åŒ… Seedanceï¼‰</div>

  </div>

  <!-- â”€â”€ è¿›åº¦å±•ç¤º â”€â”€ -->
  <div id="progress-section">
    <div class="card">
      <div class="card-title" style="margin-bottom:4px">
        â³ æ­£åœ¨ç”Ÿæˆä¸­ï¼Œè¯·å‹¿å…³é—­é¡µé¢...
      </div>
      <p style="font-size:13px;color:#999;margin-bottom:20px">
        æ•´ä¸ªæµç¨‹çº¦éœ€ 3-5 åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…
      </p>

      <div class="steps">
        <div class="step-item" id="step-1">
          <div class="step-icon pending" id="icon-1">1</div>
          <div class="step-content">
            <div class="step-label">åˆ†æäº§å“å›¾ç‰‡</div>
            <div class="step-desc" id="desc-1">GPT-4o è¯†åˆ«äº§å“å¤–è§‚ï¼Œç”Ÿæˆç™½åº•å›¾</div>
          </div>
        </div>
        <div class="step-item" id="step-2">
          <div class="step-icon pending" id="icon-2">2</div>
          <div class="step-content">
            <div class="step-label">ç”Ÿæˆè§†é¢‘è„šæœ¬</div>
            <div class="step-desc" id="desc-2">GPT-4o ç”Ÿæˆ TikTok è„šæœ¬å’Œè§†é¢‘æè¿°è¯</div>
          </div>
        </div>
        <div class="step-item" id="step-3">
          <div class="step-icon pending" id="icon-3">3</div>
          <div class="step-content">
            <div class="step-label">AI ç”Ÿæˆè§†é¢‘</div>
            <div class="step-desc" id="desc-3">Creatok æ¸²æŸ“ 15 ç§’ 9:16 çŸ­è§†é¢‘</div>
          </div>
        </div>
      </div>

      <div class="error-box" id="error-box"></div>
    </div>
  </div>

  <!-- â”€â”€ å®Œæˆ / ä¸‹è½½ â”€â”€ -->
  <div id="result-section">
    <div class="card">
      <div class="card-title" style="color:#34c759">
        âœ… è§†é¢‘ç”Ÿæˆå®Œæˆï¼
      </div>

      <div class="result-info">
        <p>
          <strong>äº§å“ï¼š</strong><span id="result-product"></span><br>
          è§†é¢‘è§„æ ¼ï¼šMP4 / 9:16 ç«–ç‰ˆ / 15 ç§’<br>
          å¯ç›´æ¥å‘å¸ƒåˆ° TikTokã€æŠ–éŸ³ã€Instagram Reels
        </p>
      </div>

      <button class="download-btn" id="download-btn" onclick="downloadVideo()">
        â¬‡ï¸ ä¸‹è½½è§†é¢‘
      </button>

      <button class="restart-btn" onclick="restartForm()">
        é‡æ–°ç”Ÿæˆå¦ä¸€ä¸ªè§†é¢‘
      </button>
    </div>
  </div>

</div><!-- /container -->

<script>
  let currentJobId = null;
  let pollTimer = null;
  let selectedService = 'seedance';

  // â”€â”€ è§†é¢‘æœåŠ¡é€‰æ‹© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function selectService(service) {
    selectedService = service;
    document.getElementById('opt-seedance').classList.toggle('selected', service === 'seedance');
    document.getElementById('opt-creatok').classList.toggle('selected', service === 'creatok');
    const costTip = document.getElementById('cost-tip');
    if (service === 'seedance') {
      costTip.textContent = 'æ¯æ¬¡ç”Ÿæˆçº¦èŠ±è´¹ Â¥0.9ï¼ˆè±†åŒ… Seedanceï¼‰';
    } else {
      costTip.textContent = 'æ¯æ¬¡ç”Ÿæˆçº¦èŠ±è´¹ Â¥2.2ï¼ˆCreatokï¼‰';
    }
  }

  // â”€â”€ å›¾ç‰‡ä¸Šä¼ å¤„ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const uploadArea = document.getElementById('upload-area');
  const imageInput = document.getElementById('image-input');

  uploadArea.addEventListener('dragover', e => {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
  });
  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('drag-over');
  });
  uploadArea.addEventListener('drop', e => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) showPreview(file);
  });

  imageInput.addEventListener('change', () => {
    if (imageInput.files[0]) showPreview(imageInput.files[0]);
  });

  function showPreview(file) {
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById('image-preview').src = e.target.result;
      document.getElementById('upload-placeholder').style.display = 'none';
      document.getElementById('preview-wrap').style.display = 'flex';
    };
    reader.readAsDataURL(file);
  }

  function resetImage(e) {
    e.stopPropagation();
    imageInput.value = '';
    document.getElementById('image-preview').src = '';
    document.getElementById('upload-placeholder').style.display = 'block';
    document.getElementById('preview-wrap').style.display = 'none';
  }

  // â”€â”€ å¼€å§‹ç”Ÿæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function startGeneration() {
    const imageFile = imageInput.files[0];
    const productName = document.getElementById('product-name').value.trim();
    const sellingPoints = document.getElementById('selling-points').value.trim();

    // å‰ç«¯æ ¡éªŒ
    if (!imageFile) {
      alert('è¯·å…ˆä¸Šä¼ äº§å“å›¾ç‰‡');
      return;
    }
    if (!productName) {
      alert('è¯·å¡«å†™äº§å“åç§°');
      return;
    }
    if (!sellingPoints) {
      alert('è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªå–ç‚¹');
      return;
    }

    // æ„å»º multipart è¡¨å•
    const formData = new FormData();
    formData.append('image', imageFile);
    formData.append('product_name', productName);
    formData.append('selling_points', sellingPoints);
    formData.append('video_service', selectedService);

    // é”å®šæŒ‰é’®
    const btn = document.getElementById('generate-btn');
    btn.disabled = true;
    btn.textContent = 'æäº¤ä¸­...';

    try {
      const res = await fetch('/api/generate', {
        method: 'POST',
        body: formData
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || 'æäº¤å¤±è´¥');
      }

      const data = await res.json();
      currentJobId = data.job_id;

      // åˆ‡æ¢åˆ°è¿›åº¦é¡µ
      document.getElementById('form-section').style.display = 'none';
      document.getElementById('progress-section').style.display = 'block';

      // å¼€å§‹è½®è¯¢
      pollTimer = setInterval(pollStatus, 4000);
      pollStatus(); // ç«‹å³æŸ¥ä¸€æ¬¡

    } catch (err) {
      btn.disabled = false;
      btn.textContent = 'å¼€å§‹ç”Ÿæˆè§†é¢‘';
      alert('é”™è¯¯ï¼š' + err.message);
    }
  }

  // â”€â”€ è½®è¯¢çŠ¶æ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  async function pollStatus() {
    if (!currentJobId) return;

    try {
      const res = await fetch(`/api/status/${currentJobId}`);
      if (!res.ok) return;
      const data = await res.json();

      updateSteps(data.step, data.status);

      if (data.status === 'success') {
        clearInterval(pollTimer);
        showResult(data.product_name);

      } else if (data.status === 'failed') {
        clearInterval(pollTimer);
        showError(data.error || 'ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
      }

    } catch (e) {
      // ç½‘ç»œé”™è¯¯ï¼Œç­‰ä¸‹æ¬¡è½®è¯¢
    }
  }

  function updateSteps(currentStep, status) {
    for (let i = 1; i <= 3; i++) {
      const icon = document.getElementById(`icon-${i}`);
      const desc = document.getElementById(`desc-${i}`);

      icon.className = 'step-icon';
      desc.className = 'step-desc';

      if (status === 'failed' && i === currentStep) {
        icon.className += ' failed';
        icon.textContent = 'âœ•';
      } else if (i < currentStep || (status === 'success' && i <= 3)) {
        icon.className += ' done';
        icon.textContent = 'âœ“';
      } else if (i === currentStep) {
        icon.className += ' active';
        icon.textContent = i;
        desc.className += ' active';
      } else {
        icon.textContent = i;
      }
    }
  }

  // â”€â”€ å®Œæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function showResult(productName) {
    updateSteps(3, 'success');
    document.getElementById('progress-section').style.display = 'none';
    document.getElementById('result-section').style.display = 'block';
    document.getElementById('result-product').textContent = productName || '';
  }

  function showError(message) {
    const box = document.getElementById('error-box');
    box.style.display = 'block';
    box.textContent = 'âŒ ' + message;
    // æŠŠç¬¬ 3 æ­¥æ ‡çº¢
    const currentStep = document.getElementById('icon-3');
    if (currentStep.classList.contains('active')) {
      currentStep.className = 'step-icon failed';
      currentStep.textContent = 'âœ•';
    }
  }

  function downloadVideo() {
    if (!currentJobId) return;
    window.location.href = `/api/download/${currentJobId}`;
  }

  function restartForm() {
    clearInterval(pollTimer);
    currentJobId = null;

    // é‡ç½®è¡¨å•
    document.getElementById('product-name').value = '';
    document.getElementById('selling-points').value = '';
    resetImage({ stopPropagation: () => {} });

    // é‡ç½®æŒ‰é’®
    const btn = document.getElementById('generate-btn');
    btn.disabled = false;
    btn.textContent = 'å¼€å§‹ç”Ÿæˆè§†é¢‘';

    // åˆ‡æ¢å›è¡¨å•é¡µ
    document.getElementById('result-section').style.display = 'none';
    document.getElementById('progress-section').style.display = 'none';
    document.getElementById('error-box').style.display = 'none';
    document.getElementById('form-section').style.display = 'block';

    // é‡ç½®æ­¥éª¤å›¾æ ‡
    for (let i = 1; i <= 3; i++) {
      const icon = document.getElementById(`icon-${i}`);
      icon.className = 'step-icon pending';
      icon.textContent = i;
      document.getElementById(`desc-${i}`).className = 'step-desc';
    }
  }
</script>

</body>
</html>
