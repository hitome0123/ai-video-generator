<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¼˜åŒ–é˜Ÿåˆ— â€” AI çŸ­è§†é¢‘ç”Ÿæˆå™¨</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f7; color: #1d1d1f; min-height: 100vh;
    }

    header {
      background: #000; color: #fff;
      padding: 18px 24px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .header-left h1 { font-size: 20px; font-weight: 700; }
    .header-left p  { font-size: 12px; color: #888; margin-top: 2px; }
    .nav-links { display: flex; gap: 8px; flex-wrap: wrap; }
    .nav-link {
      font-size: 13px; color: #aaa; text-decoration: none;
      padding: 6px 12px; border: 1px solid #444; border-radius: 8px;
      transition: color 0.2s, border-color 0.2s; white-space: nowrap;
    }
    .nav-link:hover { color: #fff; border-color: #888; }
    .nav-link.active { color: #fff; border-color: #fff; }

    .container { max-width: 800px; margin: 32px auto; padding: 0 20px 60px; }

    h2 { font-size: 22px; font-weight: 700; margin-bottom: 6px; }
    .page-sub { font-size: 14px; color: #888; margin-bottom: 24px; }

    /* Tabs */
    .tabs {
      display: flex; gap: 0; margin-bottom: 20px;
      border-bottom: 2px solid #e8e8e8;
    }
    .tab-btn {
      padding: 10px 20px; background: none; border: none;
      font-size: 14px; font-weight: 600; cursor: pointer;
      color: #aaa; border-bottom: 2px solid transparent;
      margin-bottom: -2px; transition: color 0.2s, border-color 0.2s;
    }
    .tab-btn.active { color: #000; border-bottom-color: #000; }
    .tab-badge {
      display: inline-block; background: #ff3b30; color: #fff;
      border-radius: 10px; font-size: 11px; font-weight: 700;
      padding: 1px 6px; margin-left: 5px;
    }

    /* Opt card */
    .opt-card {
      background: #fff; border-radius: 16px; padding: 22px;
      box-shadow: 0 1px 8px rgba(0,0,0,0.06); margin-bottom: 14px;
    }

    .opt-header {
      display: flex; align-items: flex-start; justify-content: space-between;
      margin-bottom: 14px; gap: 12px;
    }
    .opt-source { font-size: 15px; font-weight: 700; color: #1d1d1f; }
    .opt-roas-badge {
      background: #e8f9ef; color: #1a7c3e;
      border-radius: 8px; padding: 4px 10px;
      font-size: 13px; font-weight: 700; white-space: nowrap; flex-shrink: 0;
    }

    .opt-meta {
      display: flex; gap: 12px; flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .opt-meta-item {
      font-size: 12px; color: #888;
      background: #f5f5f7; border-radius: 6px;
      padding: 4px 10px;
    }

    .opt-strategy {
      font-size: 14px; color: #444; line-height: 1.6;
      background: #fafafa; border-radius: 10px;
      padding: 12px 14px; margin-bottom: 14px;
    }

    /* Video thumbnails placeholder */
    .thumb-row { display: flex; gap: 8px; margin-bottom: 16px; }
    .thumb {
      width: 60px; height: 96px; border-radius: 8px;
      background: linear-gradient(135deg, #e0e0e0 0%, #f5f5f5 100%);
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; flex-shrink: 0;
    }

    /* Action buttons */
    .opt-actions { display: flex; gap: 8px; }
    .btn-approve {
      flex: 1; padding: 11px; background: #34c759; color: #fff;
      border: none; border-radius: 10px;
      font-size: 14px; font-weight: 600; cursor: pointer;
      transition: opacity 0.2s;
    }
    .btn-approve:hover { opacity: 0.85; }
    .btn-reject {
      flex: 1; padding: 11px; background: none;
      border: 1.5px solid #ff3b30; color: #ff3b30;
      border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer;
      transition: background 0.2s;
    }
    .btn-reject:hover { background: #fff2f2; }

    /* Completed card */
    .done-card {
      background: #fff; border-radius: 16px; padding: 20px;
      box-shadow: 0 1px 8px rgba(0,0,0,0.06); margin-bottom: 14px;
      opacity: 0.85;
    }
    .done-header {
      display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
    }
    .done-badge {
      font-size: 11px; background: #e8f9ef; color: #1a7c3e;
      border-radius: 6px; padding: 3px 8px; font-weight: 600;
    }
    .done-source { font-size: 14px; font-weight: 600; color: #333; }
    .roas-compare {
      display: flex; align-items: center; gap: 8px;
      font-size: 13px; color: #888;
    }
    .roas-arrow { color: #34c759; font-weight: 700; }
    .done-time { font-size: 12px; color: #bbb; margin-top: 6px; }

    .empty-state {
      text-align: center; padding: 60px 20px;
      color: #aaa; font-size: 14px;
    }

    .demo-banner {
      background: #fff8e1; border: 1px solid #ffe082;
      border-radius: 10px; padding: 12px 16px;
      font-size: 13px; color: #856404; margin-bottom: 20px;
    }
  </style>
</head>
<body>

<header>
  <div class="header-left">
    <h1>AI çŸ­è§†é¢‘ç”Ÿæˆå™¨</h1>
    <p>ä¸Šä¼ äº§å“å›¾ç‰‡ï¼Œè‡ªåŠ¨ç”Ÿæˆ TikTok å¸¦è´§è§†é¢‘</p>
  </div>
  <div class="nav-links">
    <a class="nav-link" href="/index.html">è§†é¢‘ç”Ÿæˆ</a>
    <a class="nav-link" href="/batch.html">æ‰¹é‡ç”Ÿæˆ</a>
    <a class="nav-link" href="/history.html">å†å²è®°å½•</a>
    <a class="nav-link" href="/campaigns.html">å¹¿å‘Šç®¡ç†</a>
    <a class="nav-link" href="/analytics.html">æ•°æ®çœ‹æ¿</a>
    <a class="nav-link active" href="/optimization.html">ä¼˜åŒ–é˜Ÿåˆ—</a>
    <a class="nav-link" href="/settings.html">è®¾ç½®</a>
  </div>
</header>

<div class="container">
  <div class="demo-banner">
    æ¼”ç¤ºæ¨¡å¼ï¼šå½“å‰æ˜¾ç¤º Mock æ•°æ®ï¼Œä¼˜åŒ–å¼•æ“å°†åœ¨å¹¿å‘Šæ•°æ®ç§¯ç´¯åè‡ªåŠ¨è§¦å‘
  </div>

  <h2>ä¼˜åŒ–é˜Ÿåˆ—</h2>
  <p class="page-sub">AI æ ¹æ®å¹¿å‘Šæ•°æ®ç”Ÿæˆä¼˜åŒ–å»ºè®®ï¼Œäººå·¥ç¡®è®¤åè‡ªåŠ¨æŠ•æ”¾æ–°ç´ æ</p>

  <div class="tabs">
    <button class="tab-btn active" id="tab-pending" onclick="switchTab('pending')">
      å¾…ç¡®è®¤ <span class="tab-badge" id="pending-badge">0</span>
    </button>
    <button class="tab-btn" id="tab-completed" onclick="switchTab('completed')">
      å·²å®Œæˆ
    </button>
  </div>

  <div id="panel-pending"></div>
  <div id="panel-completed" style="display:none"></div>
</div>

<script>
  let queueData = null;

  async function loadQueue() {
    try {
      const res = await fetch('/api/optimization/queue');
      queueData = await res.json();
      renderPending(queueData.pending);
      renderCompleted(queueData.completed);
      document.getElementById('pending-badge').textContent = queueData.pending.length;
    } catch (e) {
      document.getElementById('panel-pending').innerHTML =
        `<div class="empty-state" style="color:#ff3b30">åŠ è½½å¤±è´¥ï¼š${e.message}</div>`;
    }
  }

  function renderPending(items) {
    const panel = document.getElementById('panel-pending');
    if (!items.length) {
      panel.innerHTML = '<div class="empty-state">æš‚æ— å¾…ç¡®è®¤çš„ä¼˜åŒ–ä»»åŠ¡<br><span style="font-size:12px;margin-top:6px;display:block">å½“å¹¿å‘Šæ•°æ®è¾¾åˆ°é˜ˆå€¼åï¼ŒAI å°†è‡ªåŠ¨ç”Ÿæˆä¼˜åŒ–å»ºè®®</span></div>';
      return;
    }

    panel.innerHTML = items.map(item => `
      <div class="opt-card" id="card-${item.id}">
        <div class="opt-header">
          <div class="opt-source">${escHtml(item.source_campaign)}</div>
          <div class="opt-roas-badge">ROAS ${item.source_roas.toFixed(2)}x</div>
        </div>
        <div class="opt-meta">
          <span class="opt-meta-item">ç”Ÿæˆäº† ${item.video_count} æ¡æ–°è§†é¢‘</span>
          <span class="opt-meta-item">Hookï¼š${escHtml(item.hook_type)}</span>
          <span class="opt-meta-item">${escHtml(item.created_at)}</span>
        </div>
        <div class="thumb-row">
          ${Array(item.video_count).fill(0).map(() => `<div class="thumb">ğŸ¬</div>`).join('')}
          <div style="display:flex;align-items:center;padding-left:6px;font-size:12px;color:#bbb">
            æ–°ç´ æé¢„è§ˆ
          </div>
        </div>
        <div class="opt-strategy">
          <strong style="font-size:12px;color:#999;display:block;margin-bottom:4px">ä¼˜åŒ–æ‘˜è¦</strong>
          ${escHtml(item.strategy)}
        </div>
        <div class="opt-actions">
          <button class="btn-approve" onclick="approve('${item.id}')">âœ… ç¡®è®¤æŠ•æ”¾</button>
          <button class="btn-reject"  onclick="reject('${item.id}')">âŒ æ‹’ç»</button>
        </div>
      </div>
    `).join('');
  }

  function renderCompleted(items) {
    const panel = document.getElementById('panel-completed');
    if (!items.length) {
      panel.innerHTML = '<div class="empty-state">æš‚æ— å·²å®Œæˆçš„ä¼˜åŒ–è®°å½•</div>';
      return;
    }

    panel.innerHTML = items.map(item => `
      <div class="done-card">
        <div class="done-header">
          <span class="done-badge">${item.status === 'approved' ? 'å·²æŠ•æ”¾' : 'å·²æ‹’ç»'}</span>
          <span class="done-source">${escHtml(item.source_campaign)}</span>
        </div>
        <div class="roas-compare">
          åŸ ROAS ${item.source_roas.toFixed(2)}x
          <span class="roas-arrow">â†’</span>
          æŠ•æ”¾å ${item.new_roas.toFixed(2)}x
          <span style="color:#34c759;font-weight:700">
            (+${((item.new_roas - item.source_roas) / item.source_roas * 100).toFixed(0)}%)
          </span>
        </div>
        <div class="done-time">ç¡®è®¤äº ${escHtml(item.approved_at)}</div>
      </div>
    `).join('');
  }

  async function approve(id) {
    const card = document.getElementById(`card-${id}`);
    const btns = card.querySelectorAll('button');
    btns.forEach(b => b.disabled = true);

    try {
      await fetch(`/api/optimization/${id}/approve`, { method: 'POST' });
      card.style.opacity = '0.5';
      card.style.transform = 'scale(0.98)';
      card.style.transition = 'all 0.3s';
      setTimeout(() => {
        card.remove();
        updateBadge();
      }, 400);
    } catch (e) {
      btns.forEach(b => b.disabled = false);
      alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
    }
  }

  async function reject(id) {
    const card = document.getElementById(`card-${id}`);
    const btns = card.querySelectorAll('button');
    btns.forEach(b => b.disabled = true);

    try {
      await fetch(`/api/optimization/${id}/reject`, { method: 'POST' });
      card.style.opacity = '0';
      card.style.transition = 'opacity 0.3s';
      setTimeout(() => {
        card.remove();
        updateBadge();
      }, 300);
    } catch (e) {
      btns.forEach(b => b.disabled = false);
      alert('æ“ä½œå¤±è´¥ï¼š' + e.message);
    }
  }

  function updateBadge() {
    const remaining = document.querySelectorAll('#panel-pending .opt-card').length;
    document.getElementById('pending-badge').textContent = remaining;
    if (remaining === 0) {
      document.getElementById('panel-pending').innerHTML =
        '<div class="empty-state">æ‰€æœ‰ä¼˜åŒ–ä»»åŠ¡å·²å¤„ç†å®Œæ¯•</div>';
    }
  }

  function switchTab(tab) {
    document.getElementById('tab-pending').classList.toggle('active', tab === 'pending');
    document.getElementById('tab-completed').classList.toggle('active', tab === 'completed');
    document.getElementById('panel-pending').style.display = tab === 'pending' ? 'block' : 'none';
    document.getElementById('panel-completed').style.display = tab === 'completed' ? 'block' : 'none';
  }

  function escHtml(s) {
    return String(s || '').replace(/[&<>"']/g, m =>
      ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])
    );
  }

  loadQueue();
</script>
</body>
</html>
