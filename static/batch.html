<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ‰¹é‡ç”Ÿæˆ - AI çŸ­è§†é¢‘ç”Ÿæˆå™¨</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f7;
      color: #1d1d1f;
      min-height: 100vh;
    }

    header {
      background: #000;
      color: #fff;
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    header h1 { font-size: 18px; font-weight: 600; }
    header p  { font-size: 12px; color: #aaa; margin-top: 2px; }
    .nav-links { display: flex; gap: 8px; flex-shrink: 0; }
    .nav-link {
      font-size: 13px; color: #aaa; text-decoration: none;
      padding: 6px 12px; border: 1px solid #444; border-radius: 8px;
    }
    .nav-link:hover { color: #fff; border-color: #888; }

    .container {
      max-width: 720px;
      margin: 36px auto;
      padding: 0 20px 60px;
    }

    .card {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    }
    .card-title {
      font-size: 14px; font-weight: 700; color: #333;
      margin-bottom: 16px;
      display: flex; align-items: center; gap: 8px;
    }

    /* â”€â”€ äº§å“æ·»åŠ è¡¨å• â”€â”€ */
    .add-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .add-row input {
      flex: 1;
      padding: 10px 14px;
      border: 1.5px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
    }
    .add-row input:focus { border-color: #000; }

    .btn-add {
      padding: 10px 18px;
      background: #000;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: opacity 0.2s;
    }
    .btn-add:hover { opacity: 0.8; }

    .add-hint { font-size: 12px; color: #aaa; margin-bottom: 16px; }

    /* â”€â”€ CSV å·¥å…· â”€â”€ */
    .csv-toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .btn-outline {
      padding: 8px 14px;
      border: 1.5px solid #ddd;
      border-radius: 8px;
      background: none;
      font-size: 13px;
      color: #555;
      cursor: pointer;
      transition: border-color 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-outline:hover { border-color: #999; color: #000; }
    #csv-file-input { display: none; }

    /* â”€â”€ äº§å“åˆ—è¡¨ â”€â”€ */
    .product-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .product-empty {
      text-align: center;
      padding: 32px;
      color: #bbb;
      font-size: 14px;
      border: 2px dashed #e8e8e8;
      border-radius: 12px;
    }
    .product-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: #f9f9f9;
      border-radius: 10px;
      border: 1px solid #f0f0f0;
    }
    .product-num {
      width: 24px; height: 24px;
      background: #000; color: #fff;
      border-radius: 50%;
      font-size: 12px; font-weight: 700;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    .product-info { flex: 1; min-width: 0; }
    .product-name { font-size: 14px; font-weight: 600; }
    .product-points { font-size: 12px; color: #888; margin-top: 2px; }
    .btn-remove {
      background: none; border: none;
      color: #ccc; font-size: 18px;
      cursor: pointer; padding: 4px;
      line-height: 1;
      transition: color 0.2s;
      flex-shrink: 0;
    }
    .btn-remove:hover { color: #ff3b30; }

    /* â”€â”€ è®¾ç½® â”€â”€ */
    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    @media (max-width: 480px) {
      .settings-grid { grid-template-columns: 1fr; }
    }

    .svc-option {
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 14px;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    .svc-option input[type=radio] { display: none; }
    .svc-option.selected { border-color: #000; background: #fafafa; }
    .svc-option:hover { border-color: #aaa; }
    .svc-name { font-size: 14px; font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; }
    .svc-badge { font-size: 10px; background: #000; color: #fff; padding: 2px 6px; border-radius: 4px; }
    .svc-desc { font-size: 12px; color: #888; }
    .svc-cost { font-size: 12px; color: #34c759; font-weight: 600; margin-top: 4px; }

    .toggle-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 0; border-bottom: 1px solid #f5f5f5;
    }
    .toggle-row:last-child { border-bottom: none; padding-bottom: 0; }
    .toggle-label { font-size: 14px; color: #333; }
    .toggle-hint  { font-size: 12px; color: #aaa; }
    .toggle { position: relative; width: 44px; height: 26px; flex-shrink: 0; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute; inset: 0; background: #ccc;
      border-radius: 26px; cursor: pointer; transition: background 0.2s;
    }
    .slider:before {
      content: ""; position: absolute;
      width: 20px; height: 20px; left: 3px; bottom: 3px;
      background: #fff; border-radius: 50%; transition: transform 0.2s;
    }
    .toggle input:checked + .slider { background: #000; }
    .toggle input:checked + .slider:before { transform: translateX(18px); }

    /* â”€â”€ å¼€å§‹æŒ‰é’® â”€â”€ */
    .start-btn {
      width: 100%; padding: 16px;
      background: #000; color: #fff; border: none;
      border-radius: 12px; font-size: 16px; font-weight: 700;
      cursor: pointer; transition: opacity 0.2s, transform 0.1s;
    }
    .start-btn:hover { opacity: 0.85; }
    .start-btn:disabled { opacity: 0.35; cursor: not-allowed; }
    .start-btn:active { transform: scale(0.99); }
    .cost-tip { text-align: center; font-size: 12px; color: #bbb; margin-top: 8px; }

    /* â”€â”€ è¿›åº¦è§†å›¾ â”€â”€ */
    #progress-view { display: none; }

    .progress-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 16px;
    }
    .progress-header h3 { font-size: 16px; font-weight: 600; }
    .progress-counter { font-size: 14px; color: #555; }

    .progress-bar-wrap {
      height: 8px; background: #f0f0f0; border-radius: 4px;
      margin-bottom: 20px; overflow: hidden;
    }
    .progress-bar {
      height: 100%; background: #000;
      border-radius: 4px; transition: width 0.5s ease;
    }

    .progress-table {
      width: 100%; border-collapse: collapse;
    }
    .progress-table th {
      font-size: 12px; color: #999; font-weight: 500;
      text-align: left; padding: 8px 10px;
      border-bottom: 1px solid #f0f0f0;
    }
    .progress-table td {
      font-size: 13px; padding: 10px;
      border-bottom: 1px solid #f5f5f5;
      vertical-align: middle;
    }
    .status-badge {
      display: inline-block;
      padding: 3px 10px; border-radius: 10px;
      font-size: 12px; font-weight: 500;
    }
    .status-badge.pending    { background: #f0f0f0; color: #888; }
    .status-badge.processing { background: #fff3cd; color: #856404; animation: pulse 1.2s infinite; }
    .status-badge.success    { background: #d4edda; color: #155724; }
    .status-badge.failed     { background: #f8d7da; color: #721c24; }

    @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.6} }

    .error-text { font-size: 11px; color: #c00; margin-top: 3px; }

    /* â”€â”€ å®Œæˆè§†å›¾ â”€â”€ */
    #done-view { display: none; }

    .done-stats {
      display: flex; gap: 16px; margin-bottom: 20px;
    }
    .stat-box {
      flex: 1; text-align: center; padding: 16px;
      background: #f5f5f7; border-radius: 12px;
    }
    .stat-num { font-size: 28px; font-weight: 700; }
    .stat-num.green { color: #34c759; }
    .stat-num.red   { color: #ff3b30; }
    .stat-label { font-size: 12px; color: #888; margin-top: 4px; }

    .btn-download-zip {
      width: 100%; padding: 16px;
      background: #34c759; color: #fff; border: none;
      border-radius: 12px; font-size: 16px; font-weight: 700;
      cursor: pointer; transition: opacity 0.2s;
      margin-bottom: 10px;
    }
    .btn-download-zip:hover { opacity: 0.85; }
    .btn-download-zip:disabled { opacity: 0.4; cursor: not-allowed; }

    .btn-restart {
      width: 100%; padding: 12px;
      background: none; border: 1.5px solid #ddd; border-radius: 12px;
      font-size: 14px; color: #555; cursor: pointer;
      transition: border-color 0.2s;
    }
    .btn-restart:hover { border-color: #999; }
  </style>
</head>
<body>

<header>
  <div>
    <h1>æ‰¹é‡ç”Ÿæˆè§†é¢‘</h1>
    <p>æœ€å¤š 20 ä¸ªäº§å“ï¼Œé˜Ÿåˆ—ç”Ÿæˆï¼Œä¸€é”®æ‰“åŒ…ä¸‹è½½</p>
  </div>
  <div class="nav-links">
    <a class="nav-link" href="/">å•ä¸ªç”Ÿæˆ</a>
    <a class="nav-link" href="/history.html">å†å²è®°å½•</a>
  </div>
</header>

<div class="container">

  <!-- â”€â”€ è¡¨å•è§†å›¾ â”€â”€ -->
  <div id="form-view">

    <!-- äº§å“åˆ—è¡¨ -->
    <div class="card">
      <div class="card-title">ğŸ“‹ æ·»åŠ äº§å“ï¼ˆæœ€å¤š 20 ä¸ªï¼‰</div>

      <div class="add-row">
        <input type="text" id="add-name" placeholder="äº§å“åç§°ï¼Œä¾‹å¦‚ï¼šæ™ºèƒ½æ‰‹è¡¨ V8 Pro">
        <input type="text" id="add-points" placeholder="å–ç‚¹ï¼ˆé€—å·åˆ†éš”ï¼‰ï¼š30å¤©ç»­èˆª,é˜²æ°´,å¿ƒç‡">
        <button class="btn-add" onclick="addProduct()">æ·»åŠ </button>
      </div>
      <div class="add-hint">æŒ‰å›è½¦å¿«é€Ÿæ·»åŠ  Â· ä¹Ÿå¯å¯¼å…¥ CSV æ–‡ä»¶æ‰¹é‡æ·»åŠ </div>

      <div class="csv-toolbar">
        <button class="btn-outline" onclick="document.getElementById('csv-file-input').click()">
          ğŸ“‚ å¯¼å…¥ CSV
        </button>
        <input type="file" id="csv-file-input" accept=".csv,.txt" onchange="importCSV(this)">
        <button class="btn-outline" onclick="downloadTemplate()">â¬‡ï¸ ä¸‹è½½ CSV æ¨¡æ¿</button>
        <button class="btn-outline" onclick="clearAll()" style="color:#c00;border-color:#ffcccc">
          ğŸ—‘ æ¸…ç©ºåˆ—è¡¨
        </button>
      </div>

      <div class="product-list" id="product-list">
        <div class="product-empty" id="empty-hint">
          æš‚æ— äº§å“ï¼Œè¯·æ‰‹åŠ¨æ·»åŠ æˆ–å¯¼å…¥ CSV
        </div>
      </div>
    </div>

    <!-- ç”Ÿæˆè®¾ç½® -->
    <div class="card">
      <div class="card-title">âš™ï¸ ç”Ÿæˆè®¾ç½®</div>

      <div class="settings-grid">
        <label class="svc-option selected" id="svc-seedance" onclick="selectSvc('seedance')">
          <input type="radio" name="svc" value="seedance" checked>
          <div class="svc-name">è±†åŒ… Seedance <span class="svc-badge">æ¨è</span></div>
          <div class="svc-desc">å›½å†…ç›´è¿ Â· 5 ç§’</div>
          <div class="svc-cost">çº¦ Â¥0.9 / ä¸ª</div>
        </label>
        <label class="svc-option" id="svc-creatok" onclick="selectSvc('creatok')">
          <input type="radio" name="svc" value="creatok">
          <div class="svc-name">Creatok</div>
          <div class="svc-desc">å›½é™…æœåŠ¡ Â· 15 ç§’</div>
          <div class="svc-cost">çº¦ Â¥2.2 / ä¸ª</div>
        </label>
      </div>

      <div class="toggle-row">
        <div>
          <div class="toggle-label">è‡ªåŠ¨æ·»åŠ å­—å¹•</div>
          <div class="toggle-hint">éœ€å®‰è£… FFmpeg</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="tog-subtitle">
          <span class="slider"></span>
        </label>
      </div>
      <div class="toggle-row">
        <div>
          <div class="toggle-label">æ··å…¥èƒŒæ™¯éŸ³ä¹</div>
          <div class="toggle-hint">éœ€åœ¨ static/bgm/ æ”¾ç½® mp3 æ–‡ä»¶</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="tog-bgm">
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <button class="start-btn" id="start-btn" onclick="startBatch()" disabled>
      å¼€å§‹æ‰¹é‡ç”Ÿæˆï¼ˆ0 ä¸ªäº§å“ï¼‰
    </button>
    <div class="cost-tip" id="cost-tip">æ·»åŠ äº§å“åå¯å¼€å§‹ç”Ÿæˆ</div>

  </div>

  <!-- â”€â”€ è¿›åº¦è§†å›¾ â”€â”€ -->
  <div id="progress-view">
    <div class="card">
      <div class="progress-header">
        <h3>â³ æ‰¹é‡ç”Ÿæˆä¸­...</h3>
        <span class="progress-counter" id="prog-counter">0 / 0</span>
      </div>
      <div class="progress-bar-wrap">
        <div class="progress-bar" id="prog-bar" style="width:0%"></div>
      </div>
      <table class="progress-table">
        <thead>
          <tr>
            <th>#</th>
            <th>äº§å“åç§°</th>
            <th>çŠ¶æ€</th>
          </tr>
        </thead>
        <tbody id="prog-tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- â”€â”€ å®Œæˆè§†å›¾ â”€â”€ -->
  <div id="done-view">
    <div class="card">
      <div class="card-title" style="color:#34c759">âœ… æ‰¹é‡ç”Ÿæˆå®Œæˆ</div>

      <div class="done-stats">
        <div class="stat-box">
          <div class="stat-num green" id="stat-success">0</div>
          <div class="stat-label">ç”ŸæˆæˆåŠŸ</div>
        </div>
        <div class="stat-box">
          <div class="stat-num red" id="stat-fail">0</div>
          <div class="stat-label">ç”Ÿæˆå¤±è´¥</div>
        </div>
      </div>

      <button class="btn-download-zip" id="zip-btn" onclick="downloadZip()">
        â¬‡ï¸ ä¸‹è½½å…¨éƒ¨è§†é¢‘ï¼ˆZIPï¼‰
      </button>
      <button class="btn-restart" onclick="restart()">
        é‡æ–°æ‰¹é‡ç”Ÿæˆ
      </button>
    </div>
  </div>

</div>

<script>
  let products = [];
  let selectedSvc = 'seedance';
  let currentBatchId = null;
  let pollTimer = null;

  // â”€â”€ æœåŠ¡é€‰æ‹© â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function selectSvc(svc) {
    selectedSvc = svc;
    document.getElementById('svc-seedance').classList.toggle('selected', svc === 'seedance');
    document.getElementById('svc-creatok').classList.toggle('selected', svc === 'creatok');
    updateCostTip();
  }

  function updateCostTip() {
    const n = products.length;
    if (n === 0) {
      document.getElementById('cost-tip').textContent = 'æ·»åŠ äº§å“åå¯å¼€å§‹ç”Ÿæˆ';
      return;
    }
    const unit = selectedSvc === 'seedance' ? 0.9 : 2.2;
    const total = (n * unit).toFixed(1);
    const svcName = selectedSvc === 'seedance' ? 'è±†åŒ… Seedance' : 'Creatok';
    document.getElementById('cost-tip').textContent =
      `${n} ä¸ªäº§å“ Ã— çº¦ Â¥${unit} = çº¦ Â¥${total}ï¼ˆ${svcName}ï¼‰`;
  }

  // â”€â”€ äº§å“ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function addProduct() {
    const name = document.getElementById('add-name').value.trim();
    const pointsRaw = document.getElementById('add-points').value.trim();
    if (!name) { document.getElementById('add-name').focus(); return; }

    const points = pointsRaw
      ? pointsRaw.split(',').map(p => p.trim()).filter(Boolean)
      : [];

    if (products.length >= 20) {
      alert('æœ€å¤šæ·»åŠ  20 ä¸ªäº§å“');
      return;
    }

    products.push({ product_name: name, selling_points: points });
    document.getElementById('add-name').value = '';
    document.getElementById('add-points').value = '';
    document.getElementById('add-name').focus();
    renderList();
  }

  function removeProduct(idx) {
    products.splice(idx, 1);
    renderList();
  }

  function clearAll() {
    if (products.length === 0) return;
    if (!confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰äº§å“ï¼Ÿ')) return;
    products = [];
    renderList();
  }

  function renderList() {
    const container = document.getElementById('product-list');
    const emptyHint = document.getElementById('empty-hint');
    const btn = document.getElementById('start-btn');

    if (products.length === 0) {
      container.innerHTML = '';
      container.appendChild(emptyHint);
      emptyHint.style.display = 'block';
      btn.disabled = true;
      btn.textContent = 'å¼€å§‹æ‰¹é‡ç”Ÿæˆï¼ˆ0 ä¸ªäº§å“ï¼‰';
    } else {
      emptyHint.style.display = 'none';
      container.innerHTML = products.map((p, i) => `
        <div class="product-item">
          <div class="product-num">${i + 1}</div>
          <div class="product-info">
            <div class="product-name">${escHtml(p.product_name)}</div>
            <div class="product-points">${p.selling_points.length ? escHtml(p.selling_points.join(' Â· ')) : 'æš‚æ— å–ç‚¹'}</div>
          </div>
          <button class="btn-remove" onclick="removeProduct(${i})">Ã—</button>
        </div>
      `).join('');
      btn.disabled = false;
      btn.textContent = `å¼€å§‹æ‰¹é‡ç”Ÿæˆï¼ˆ${products.length} ä¸ªäº§å“ï¼‰`;
    }
    updateCostTip();
  }

  // å›è½¦æ·»åŠ 
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('add-points').addEventListener('keydown', e => {
      if (e.key === 'Enter') addProduct();
    });
    document.getElementById('add-name').addEventListener('keydown', e => {
      if (e.key === 'Enter') document.getElementById('add-points').focus();
    });
  });

  // â”€â”€ CSV å¯¼å…¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function importCSV(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      const lines = e.target.result.split('\n').filter(l => l.trim());
      let added = 0;
      lines.forEach((line, idx) => {
        if (idx === 0 && line.toLowerCase().startsWith('äº§å“åç§°')) return; // skip header
        const cols = line.split(',').map(c => c.trim());
        if (!cols[0]) return;
        if (products.length >= 20) return;
        products.push({
          product_name: cols[0],
          selling_points: cols.slice(1).filter(Boolean),
        });
        added++;
      });
      renderList();
      if (added > 0) alert(`æˆåŠŸå¯¼å…¥ ${added} ä¸ªäº§å“`);
      else alert('æœªæ‰¾åˆ°æœ‰æ•ˆäº§å“æ•°æ®ï¼Œè¯·æ£€æŸ¥ CSV æ ¼å¼');
    };
    reader.readAsText(file, 'UTF-8');
    input.value = '';
  }

  function downloadTemplate() {
    const csv = 'äº§å“åç§°,å–ç‚¹1,å–ç‚¹2,å–ç‚¹3,å–ç‚¹4\næ™ºèƒ½æ‰‹è¡¨V8 Pro,30å¤©ç»­èˆª,50ç±³é˜²æ°´,å¿ƒç‡ç›‘æµ‹,NFCæ”¯ä»˜\né™å™ªè€³æœºX1,ä¸»åŠ¨é™å™ª,40å°æ—¶ç»­èˆª,å¿«å……,IPX5é˜²æ°´\n';
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'æ‰¹é‡ç”Ÿæˆæ¨¡æ¿.csv';
    a.click();
  }

  // â”€â”€ å¼€å§‹æ‰¹é‡ç”Ÿæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function startBatch() {
    if (products.length === 0) return;

    const btn = document.getElementById('start-btn');
    btn.disabled = true;
    btn.textContent = 'æäº¤ä¸­...';

    try {
      const res = await fetch('/api/batch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          items: products,
          video_service: selectedSvc,
          add_subtitle: document.getElementById('tog-subtitle').checked,
          add_bgm: document.getElementById('tog-bgm').checked,
        })
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || 'æäº¤å¤±è´¥');
      }

      const data = await res.json();
      currentBatchId = data.batch_id;

      // åˆ‡æ¢åˆ°è¿›åº¦è§†å›¾
      document.getElementById('form-view').style.display = 'none';
      document.getElementById('progress-view').style.display = 'block';

      // åˆå§‹åŒ–è¿›åº¦è¡¨æ ¼
      initProgressTable(products);

      // å¼€å§‹è½®è¯¢
      pollTimer = setInterval(pollBatch, 5000);
      pollBatch();

    } catch (err) {
      btn.disabled = false;
      btn.textContent = `å¼€å§‹æ‰¹é‡ç”Ÿæˆï¼ˆ${products.length} ä¸ªäº§å“ï¼‰`;
      alert('é”™è¯¯ï¼š' + err.message);
    }
  }

  function initProgressTable(prods) {
    const tbody = document.getElementById('prog-tbody');
    tbody.innerHTML = prods.map((p, i) => `
      <tr id="row-${i}">
        <td>${i + 1}</td>
        <td>${escHtml(p.product_name)}</td>
        <td><span class="status-badge pending" id="status-${i}">ç­‰å¾…ä¸­</span></td>
      </tr>
    `).join('');
  }

  // â”€â”€ è½®è¯¢æ‰¹é‡çŠ¶æ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function pollBatch() {
    if (!currentBatchId) return;
    try {
      const res = await fetch(`/api/batch/${currentBatchId}`);
      if (!res.ok) return;
      const data = await res.json();

      // æ›´æ–°è¿›åº¦æ¡
      const pct = data.total > 0 ? Math.round((data.completed + data.failed) / data.total * 100) : 0;
      document.getElementById('prog-bar').style.width = pct + '%';
      document.getElementById('prog-counter').textContent = `${data.completed + data.failed} / ${data.total}`;

      // æ›´æ–°æ¯è¡ŒçŠ¶æ€
      data.items.forEach((item, idx) => {
        const badge = document.getElementById(`status-${idx}`);
        if (!badge) return;
        const labels = { pending: 'ç­‰å¾…ä¸­', processing: 'ç”Ÿæˆä¸­', success: 'âœ… æˆåŠŸ', failed: 'âŒ å¤±è´¥' };
        badge.className = `status-badge ${item.status}`;
        badge.textContent = labels[item.status] || item.status;

        // æ˜¾ç¤ºé”™è¯¯
        const row = document.getElementById(`row-${idx}`);
        if (item.status === 'failed' && item.error && row) {
          const existing = row.querySelector('.error-row');
          if (!existing) {
            const errTr = document.createElement('tr');
            errTr.className = 'error-row';
            errTr.innerHTML = `<td></td><td colspan="2"><div class="error-text">${escHtml(item.error)}</div></td>`;
            row.insertAdjacentElement('afterend', errTr);
          }
        }
      });

      if (data.status === 'done') {
        clearInterval(pollTimer);
        showDone(data);
      }

    } catch (e) { /* ç½‘ç»œé”™è¯¯ï¼Œç­‰ä¸‹æ¬¡ */ }
  }

  function showDone(data) {
    document.getElementById('progress-view').style.display = 'none';
    document.getElementById('done-view').style.display = 'block';
    document.getElementById('stat-success').textContent = data.completed;
    document.getElementById('stat-fail').textContent = data.failed;

    const zipBtn = document.getElementById('zip-btn');
    if (data.completed === 0) {
      zipBtn.disabled = true;
      zipBtn.textContent = 'æ²¡æœ‰æˆåŠŸç”Ÿæˆçš„è§†é¢‘';
    }
  }

  function downloadZip() {
    if (!currentBatchId) return;
    window.location.href = `/api/batch/${currentBatchId}/download`;
  }

  function restart() {
    clearInterval(pollTimer);
    currentBatchId = null;
    products = [];

    document.getElementById('done-view').style.display = 'none';
    document.getElementById('progress-view').style.display = 'none';
    document.getElementById('form-view').style.display = 'block';

    const btn = document.getElementById('start-btn');
    btn.disabled = true;
    btn.textContent = 'å¼€å§‹æ‰¹é‡ç”Ÿæˆï¼ˆ0 ä¸ªäº§å“ï¼‰';
    renderList();
  }

  function escHtml(str) {
    return String(str).replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    })[m]);
  }
</script>

</body>
</html>
